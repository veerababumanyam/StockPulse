# Story 2.5: Develop AI Insights Panel Widget

**Epic:** [Dashboard Core Functionality](../epic-2.md)
**Status:** Draft
**Priority:** High
**Points:** (Estimate)
**Assigned To:** 
**Sprint:** 

## 1. User Story

> As a user,
> I want an "AI Insights Panel" widget on my Dashboard that provides concise, actionable insights, market sentiment summaries, and explanations generated by a RAG-powered AI Market Insights Agent, and allows me to ask clarifying financial questions,
> So that I can stay informed about market trends, potential opportunities, the rationale behind AI-driven suggestions, and deepen my understanding of financial topics.

## 2. Requirements

*   The widget must be selectable and placeable on the dashboard via the Customizable Widget System (Story 2.2).
*   The widget will be powered by the "Market Insights AI Agent."
*   **RAG-Powered Insights:** The agent will utilize a RAG pipeline with `StockPulse_VectorDB` (containing news, market analysis, financial documents, etc.) to generate insights.
*   The panel should display a variety of insights, including but not limited to:
    *   Overall market sentiment (e.g., Bullish, Bearish, Neutral with a brief RAG-informed explanation).
    *   Potentially trending sectors or industries based on RAG analysis.
    *   Specific stock signals (e.g., "AAPL showing strong bullish pattern") with confidence scores and RAG-informed rationale.
    *   Key news-driven insights with sentiment (e.g., "Positive news sentiment for MSFT regarding new product launch, based on [retrieved source]").
*   **Natural Language Query (NLQ) Input (Optional V2/Stretch):** Include an input field allowing users to ask financial questions to the Market Insights AI Agent (e.g., "What caused the market dip yesterday?", "Explain P/E ratio for AAPL."). The agent will use RAG to answer.
*   Insights should be presented clearly and concisely.
*   Include a timestamp for each insight to indicate its recency.
*   Data should update in near real-time or at frequent intervals as new insights are generated by the backend AI engine.
*   Clicking on a specific insight (e.g., a stock signal) could lead to more detailed information (e.g., navigate to `StockDetailPage.tsx` or a dedicated analysis view).
*   Handle empty states (no new insights) or loading states gracefully.

## 3. Acceptance Criteria (ACs)

1.  **AC1:** Given the "AI Insights Panel" widget is added to the dashboard, when the Market Insights AI Agent provides insights, then a list or feed of RAG-powered insights (e.g., market sentiment, stock signals, news summaries) is displayed, each with a timestamp and brief explanation/rationale.
2.  **AC2:** Given the widget is displayed, when new AI insights are generated by the backend, then the panel updates to show the latest insights without requiring a page refresh.
3.  **AC3:** Given a user clicks on a stock-specific insight in the panel, then they are navigated to the relevant `StockDetailPage.tsx` for that stock, or a more detailed analysis view if applicable.
4.  **AC4:** Given the widget is loading data, then a clear loading indicator is displayed.
5.  **AC5:** Given an error occurs while fetching AI insights, then a user-friendly error message is displayed within the widget.
6.  **AC6:** Given no new AI insights are currently available, then an appropriate message (e.g., "No new AI insights at the moment. Check back soon!") is displayed.
7.  **AC7:** Insights are clearly distinguishable by type (e.g., market sentiment vs. stock signal vs. news insight) through visual cues or labeling.
8.  **AC8 (New - NLQ, Optional V2):** If NLQ input is implemented, given a user types a financial question and submits, then the Market Insights AI Agent provides a RAG-powered answer within the panel.

## 4. Technical Guidance for Developer Agent

*   **Relevant PRD Sections:**
    *   `PRD.md#3.5.1` (Dashboard - AI insights panel)
    *   `PRD.md#1.3` (Key Value Propositions - Transparency, AI-Powered Trading)
    *   `PRD.md#3.2` (AI and Analysis Engine - Multi-LLM, Market Analysis, Signal Generation)
*   **Relevant Architecture Sections:**
    *   `architecture.md#3.2.2` (AI/ML Service - MCP Integration) -> To be updated for Market Insights Agent
    *   `architecture.md#4` (MCP Integration - for how AI insights are sourced) -> To be updated for Market Insights Agent
    *   `docs/infrastructure_design.md#5.1` (RAG Pipeline)
    *   `docs/infrastructure_design.md#5.2` (AI Agent Architecture - Market Insights AI Agent)
    *   `docs/infrastructure_design.md#4.3` (StockPulse_VectorDB)
*   **Key Components/Modules to be affected/created:**
    *   New Widget Component: `src/components/widgets/AIInsightsWidget.tsx`.
    *   Service: `src/services/aiAgentService.ts` (or similar) to interact with the Market Insights AI Agent (fetch proactive insights, submit NLQs).
    *   Real-time Integration: Logic to subscribe to WebSocket updates for new proactive insights or poll the API.
    *   UI Elements: Components to render different types of insight cards/items, and an optional input field for NLQ.
*   **API Endpoints Involved:**
    *   `GET /api/v1/agents/market-insights/proactive` (To fetch current proactive AI insights).
        *   Expected Response: An array of insight objects (similar to original story, but explicitly RAG-generated).
    *   `POST /api/v1/agents/market-insights/query` (For NLQ, if implemented)
        *   Request Body: `{ "userId": "uuid-user", "queryText": "Explain the recent drop in oil prices." }`
        *   Expected Response: `{ "answerText": "The recent drop in oil prices can be attributed to [RAG-informed explanation...].", "sources": [ { "title": "Source 1", "url": "..."} ] }`
    *   WebSocket endpoint for real-time proactive insight pushes (details TBD with backend).
*   **Styling/UI Notes:**
    *   Align with `StockPulse_Design.md`. Insights should be easy to scan and differentiate.
    *   Consider using icons or color-coding for different insight types.
*   **Error Handling Notes:**
    *   Handle API errors gracefully.

## 5. Tasks / Subtasks

1.  **Task 1 (AC1):** Create the basic structure for `AIInsightsWidget.tsx`.
2.  **Task 2 (AC1, AC4, AC5):** Implement service function to fetch AI insights from the backend API.
3.  **Task 3 (AC1, AC4, AC5, AC6):** Integrate data fetching into the widget. Implement loading, error, and empty states.
4.  **Task 4 (AC1, AC7):** Design and implement UI components to render individual insights based on their type (market sentiment, stock signal, news).
5.  **Task 5 (AC2):** Implement real-time updates for the proactive insights feed (via WebSocket or polling).
6.  **Task 6 (AC3):** Implement navigation to detailed views (e.g., `StockDetailPage.tsx`) when a relevant insight is clicked.
7.  **Task 7 (AC8 - Optional V2):** If NLQ is scoped, implement the input field and integrate the `/api/v1/agents/market-insights/query` API call, displaying the agent's answer.
8.  **Task 8 (N/A):** Style the widget according to `StockPulse_Design.md`.
9.  **Task 9 (N/A):** Write unit tests.

## 6. Definition of Done (DoD)

*   All core Acceptance Criteria (AC1-AC7) met. (AC8 is optional V2).
*   AI Insights Panel widget fetches and displays various RAG-powered insights from the Market Insights AI Agent.
*   (If NLQ V2 implemented) Users can ask financial questions and receive RAG-powered answers.
*   Panel updates in near real-time for proactive insights.
*   Users can navigate to more details from specific insights.
*   Loading, error, and empty states are handled gracefully.
*   Widget integrates correctly with the customizable dashboard system.
*   Code reviewed, merged, tests passing.

## 7. Notes / Questions

*   Confirm exact API endpoint and data structure for AI insights (both for REST and WebSocket if applicable).
*   Define the initial set of insight types to be supported and their specific display requirements.
*   Clarify the expected frequency of AI insight generation and updates.
*   Define scope for NLQ feature (V1 or V2). For V1, focus on displaying proactive RAG-powered insights.

## 8. Design / UI Mockup Links (If Applicable)

*   Refer to `docs/StockPulse_Design.md` for widget styling, card components, and information display guidelines.

## Story Progress Notes

### Agent Model Used: `<Agent Model Name/Version>`

### Completion Notes List

{Any notes about implementation choices, difficulties, or follow-up needed}

### Change Log 